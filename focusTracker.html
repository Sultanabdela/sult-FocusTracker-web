<!DOCTYPE html>
<html lang="en" class="transition-colors duration-200">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FocusTracker | Pomodoro Productivity</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .dark ::-webkit-scrollbar-thumb { background-color: #475569; }

        /* Timer Progress Ring Animation */
        .progress-ring__circle {
            transition: stroke-dashoffset 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .pop-in { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .confetti { position: fixed; width: 10px; height: 10px; background-color: #f00; animation: fall linear forwards; z-index: 9999; }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 min-h-screen flex flex-col transition-colors duration-200">

    <!-- LOGIN MODAL (Overlay) -->
    <div id="login-overlay" class="fixed inset-0 z-[100] bg-gray-50 dark:bg-gray-900 flex flex-col items-center justify-center transition-colors duration-200">
        <div class="max-w-md w-full px-6">
            <div class="text-center mb-10">
                <div class="inline-block p-4 rounded-2xl bg-indigo-100 dark:bg-indigo-900/30 mb-4">
                    <i class="fa-solid fa-layer-group text-4xl text-indigo-600 dark:text-indigo-400"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">FocusFlow</h1>
                <p class="text-gray-500 dark:text-gray-400">Your personal productivity companion.</p>
            </div>
            
            <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-xl border border-gray-100 dark:border-gray-700">
                <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-2">Who are you?</label>
                <div class="flex gap-2 mb-6">
                    <input type="text" id="login-username" placeholder="Enter your name" class="flex-1 bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-white border border-gray-200 dark:border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500" onkeypress="if(event.key === 'Enter') app.login()">
                    <button onclick="app.login()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold px-6 py-3 rounded-lg transition">
                        <i class="fa-solid fa-arrow-right"></i>
                    </button>
                </div>
                <p class="text-xs text-gray-400 text-center">
                    <i class="fa-solid fa-lock mr-1"></i> Your data is stored locally in this browser.
                </p>
            </div>
        </div>
    </div>

    <!-- Top Bar: Quote & Header -->
    <header class="bg-white dark:bg-gray-800 shadow-sm z-10 transition-colors duration-200">
        <div class="max-w-5xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2 text-indigo-600 dark:text-indigo-400 font-bold text-xl">
                <i class="fa-solid fa-layer-group"></i> <span class="hidden sm:inline">FocusTracker</span>
            </div>
            <div class="flex gap-3 items-center">
                
                <!-- Global Streak Counter (New) -->
                <div class="flex items-center gap-1 px-2 py-1 bg-orange-50 dark:bg-orange-900/20 rounded-lg text-orange-600 dark:text-orange-400 mr-1" title="Daily Goal Streak">
                    <i class="fa-solid fa-fire"></i>
                    <span id="global-streak-count" class="font-bold text-sm">0</span>
                </div>

                <!-- User Profile Display -->
                <div class="hidden sm:flex items-center gap-2 px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full text-xs font-medium text-gray-600 dark:text-gray-300 mr-2">
                    <i class="fa-solid fa-user-circle text-gray-400"></i>
                    <span id="user-display-name">Guest</span>
                </div>

                <button onclick="app.toggleTheme()" class="text-gray-500 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" title="Toggle Dark Mode">
                    <i id="theme-icon" class="fa-solid fa-moon text-lg"></i>
                </button>
                
                <div class="w-px h-6 bg-gray-200 dark:bg-gray-700 mx-1"></div>
                
                <button onclick="app.toggleView('dashboard')" class="text-gray-500 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition" title="Dashboard">
                    <i class="fa-solid fa-list-check text-lg"></i>
                </button>
                <button onclick="app.toggleView('planner')" class="text-gray-500 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition" title="Planner">
                    <i class="fa-regular fa-calendar text-lg"></i>
                </button>
                <button onclick="app.toggleView('challenges')" class="text-gray-500 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition" title="Challenges">
                    <i class="fa-solid fa-trophy text-lg"></i>
                </button>
                <button onclick="app.toggleView('reports')" class="text-gray-500 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition" title="Reports">
                    <i class="fa-solid fa-chart-pie text-lg"></i>
                </button>
                <button onclick="app.toggleSettings()" class="text-gray-500 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition" title="Settings">
                    <i class="fa-solid fa-gear text-lg"></i>
                </button>
                
                <div class="w-px h-6 bg-gray-200 dark:bg-gray-700 mx-1"></div>

                <button onclick="app.logout()" class="text-gray-400 hover:text-red-500 transition" title="Logout">
                    <i class="fa-solid fa-right-from-bracket text-lg"></i>
                </button>
            </div>
        </div>
        <!-- Quote Banner -->
        <div id="quote-banner" class="bg-indigo-50 dark:bg-gray-900/50 text-indigo-800 dark:text-indigo-300 text-xs sm:text-sm text-center py-2 px-4 border-b border-indigo-100 dark:border-gray-800 italic font-medium transition-all duration-500">
            "Loading inspiration..."
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 relative">
        <div class="max-w-5xl mx-auto p-4 pb-24 space-y-6">

            <!-- VIEW: DASHBOARD (Timer + Tasks) -->
            <div id="view-dashboard" class="fade-in grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <!-- Left Col: Timer -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 p-6 flex flex-col items-center justify-center md:sticky md:top-4 z-0 transition-colors duration-200 h-fit">
                    
                    <!-- Timer Tabs -->
                    <div class="flex bg-gray-100 dark:bg-gray-700 p-1 rounded-lg mb-6 w-full max-w-xs transition-colors duration-200">
                        <button onclick="timer.setMode('pomodoro')" id="tab-pomodoro" class="flex-1 py-1 text-sm font-medium rounded-md shadow-sm bg-white dark:bg-gray-600 text-indigo-600 dark:text-indigo-300 transition-all">Focus</button>
                        <button onclick="timer.setMode('shortBreak')" id="tab-shortBreak" class="flex-1 py-1 text-sm font-medium rounded-md text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition-all">Short</button>
                        <button onclick="timer.setMode('longBreak')" id="tab-longBreak" class="flex-1 py-1 text-sm font-medium rounded-md text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition-all">Long</button>
                    </div>

                    <!-- Circular Timer -->
                    <div class="relative w-64 h-64 mb-6">
                        <svg class="w-full h-full" viewBox="0 0 120 120">
                            <circle class="text-gray-100 dark:text-gray-700 transition-colors duration-200" stroke-width="8" stroke="currentColor" fill="transparent" r="52" cx="60" cy="60" />
                            <circle id="timer-ring" class="text-indigo-600 dark:text-indigo-500 progress-ring__circle transition-colors duration-200" stroke-width="8" stroke-linecap="round" stroke="currentColor" fill="transparent" r="52" cx="60" cy="60" stroke-dasharray="326.72" stroke-dashoffset="0" />
                        </svg>
                        <div class="absolute top-0 left-0 w-full h-full flex flex-col items-center justify-center text-gray-800 dark:text-white">
                            <div id="timer-display" class="text-5xl font-bold tracking-tight transition-colors duration-200">25:00</div>
                            <div id="timer-status" class="text-sm text-gray-400 dark:text-gray-500 font-medium mt-1 uppercase tracking-wider transition-colors duration-200">Ready</div>
                        </div>
                    </div>

                    <!-- Controls -->
                    <div class="flex gap-4 w-full justify-center">
                        <button id="btn-toggle" onclick="timer.toggle()" class="bg-indigo-600 hover:bg-indigo-700 dark:bg-indigo-600 dark:hover:bg-indigo-500 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg transition transform active:scale-95">
                            <i class="fa-solid fa-play text-xl pl-1"></i>
                        </button>
                        <button id="btn-stop" onclick="timer.stop()" class="bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-600 dark:text-gray-300 rounded-full w-14 h-14 flex items-center justify-center transition" title="Stop & Reset (Don't Record)">
                            <i class="fa-solid fa-stop text-lg"></i>
                        </button>
                    </div>

                    <!-- Active Task Indicator -->
                    <div id="active-task-display" class="mt-6 text-center hidden">
                        <div class="text-xs font-semibold text-indigo-400 dark:text-indigo-300 uppercase mb-1">Current Task</div>
                        <div id="active-task-title" class="font-medium text-gray-800 dark:text-gray-100 truncate max-w-[250px]">writing code</div>
                    </div>
                </div>

                <!-- Right Col: Task List -->
                <div class="flex flex-col h-full">
                    
                    <!-- Daily Goal Progress Bar (New) -->
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 mb-4">
                        <div class="flex justify-between items-end mb-2">
                            <div>
                                <div class="text-xs font-bold text-gray-400 uppercase tracking-wider">Daily Goal</div>
                                <div class="text-lg font-bold text-gray-800 dark:text-white">
                                    <span id="goal-current">0</span> / <span id="goal-target">4</span> Poms
                                </div>
                            </div>
                            <div class="text-xs font-medium text-indigo-500" id="goal-status-text">Keep going!</div>
                        </div>
                        <div class="w-full bg-gray-100 dark:bg-gray-700 rounded-full h-2.5">
                            <div id="goal-progress-bar" class="bg-indigo-600 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-gray-800 dark:text-white">Today's Tasks</h2>
                        <button onclick="tasks.clearCompleted()" class="text-xs text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 font-medium">Clear Done</button>
                    </div>

                    <!-- Add Task Input -->
                    <div class="bg-white dark:bg-gray-800 p-3 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 mb-4 transition-colors duration-200">
                        <div class="flex flex-col gap-2">
                            <input type="text" id="new-task-title" placeholder="What are you working on today?" class="w-full text-gray-700 dark:text-gray-200 placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none text-sm font-medium bg-transparent" onkeypress="if(event.key === 'Enter') tasks.add()">
                            <div class="flex justify-between items-center border-t border-gray-50 dark:border-gray-700 pt-2 mt-1">
                                <div class="flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400">
                                    <span class="text-xs font-semibold uppercase">No-Of Pomodoros:</span>
                                    <input type="number" id="new-task-est" value="1" min="1" max="10" class="w-12 bg-gray-50 dark:bg-gray-700 dark:text-white rounded border border-gray-200 dark:border-gray-600 px-1 text-center focus:outline-none focus:border-indigo-500">
                                </div>
                                <button onclick="tasks.add()" class="bg-indigo-50 dark:bg-gray-700 text-indigo-600 dark:text-indigo-300 hover:bg-indigo-100 dark:hover:bg-gray-600 p-2 rounded-lg transition text-xs font-bold uppercase tracking-wide">
                                    Add <i class="fa-solid fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Task List Items -->
                    <div id="task-list" class="space-y-3 flex-1" style="min-height: 200px;">
                        <!-- Tasks injected via JS -->
                    </div>
                    
                    <!-- Empty State -->
                    <div id="empty-state" class="hidden flex-col items-center justify-center py-10 text-gray-400 dark:text-gray-500">
                        <i class="fa-solid fa-clipboard-check text-4xl mb-3 text-gray-200 dark:text-gray-700"></i>
                        <p class="text-sm">No tasks for today. Add one above!</p>
                    </div>
                </div>
            </div>

            <!-- VIEW: PLANNER -->
            <div id="view-planner" class="hidden fade-in">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Future Planner</h2>
                    <p class="text-gray-500 dark:text-gray-400 text-sm">Set high-level goals and move them to "Today" when ready.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Planner Cols (Same as before) -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-4 h-[500px] flex flex-col">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold text-gray-800 dark:text-gray-200"><i class="fa-regular fa-calendar-days mr-2 text-indigo-500"></i>This Week</h3>
                        </div>
                        <div class="flex gap-2 mb-3">
                            <input type="text" id="planner-weekly-input" placeholder="Add weekly goal..." class="flex-1 bg-gray-50 dark:bg-gray-700 text-sm rounded px-3 py-2 outline-none dark:text-white" onkeypress="if(event.key === 'Enter') planner.add('weekly')">
                            <button onclick="planner.add('weekly')" class="bg-indigo-50 dark:bg-gray-600 text-indigo-600 dark:text-indigo-300 px-3 rounded hover:bg-indigo-100 dark:hover:bg-gray-500 transition"><i class="fa-solid fa-plus"></i></button>
                        </div>
                        <div id="planner-weekly-list" class="flex-1 overflow-y-auto space-y-2 pr-1"></div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-4 h-[500px] flex flex-col">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold text-gray-800 dark:text-gray-200"><i class="fa-regular fa-calendar mr-2 text-purple-500"></i>This Month</h3>
                        </div>
                        <div class="flex gap-2 mb-3">
                            <input type="text" id="planner-monthly-input" placeholder="Add monthly goal..." class="flex-1 bg-gray-50 dark:bg-gray-700 text-sm rounded px-3 py-2 outline-none dark:text-white" onkeypress="if(event.key === 'Enter') planner.add('monthly')">
                            <button onclick="planner.add('monthly')" class="bg-purple-50 dark:bg-gray-600 text-purple-600 dark:text-purple-300 px-3 rounded hover:bg-purple-100 dark:hover:bg-gray-500 transition"><i class="fa-solid fa-plus"></i></button>
                        </div>
                        <div id="planner-monthly-list" class="flex-1 overflow-y-auto space-y-2 pr-1"></div>
                    </div>
                </div>
            </div>

            <!-- VIEW: CHALLENGES -->
            <div id="view-challenges" class="hidden fade-in space-y-6">
                <!-- (Challenge Code same as before, accessible via tab) -->
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-2"><i class="fa-solid fa-fire text-orange-500 mr-2"></i>Consistency Challenge</h2>
                    <p class="text-gray-500 dark:text-gray-400 text-sm">Build a habit by reaching a daily focus goal.</p>
                </div>
                <div id="challenge-setup" class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 max-w-md mx-auto text-center hidden">
                    <div class="w-16 h-16 bg-indigo-100 dark:bg-indigo-900/50 rounded-full flex items-center justify-center mx-auto mb-4 text-indigo-600 dark:text-indigo-400 text-2xl"><i class="fa-solid fa-flag-checkered"></i></div>
                    <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-6">Start a New Challenge</h3>
                    <div class="space-y-6 mb-8 text-left">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-2">Challenge Goal / Task Name</label>
                            <input type="text" id="challenge-task-input" placeholder="e.g. Read Books, Learn JS" class="w-full bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-white border border-gray-200 dark:border-gray-600 rounded-lg p-2.5 text-sm focus:outline-none focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-2">Duration</label>
                            <div class="grid grid-cols-3 gap-3">
                                <button onclick="challenges.selectDuration(30)" class="challenge-dur-btn p-2 border border-gray-200 dark:border-gray-600 rounded-lg hover:border-indigo-500 hover:bg-indigo-50 dark:hover:bg-gray-700 text-sm font-medium text-gray-700 dark:text-gray-200 transition" data-val="30">30 Days</button>
                                <button onclick="challenges.selectDuration(60)" class="challenge-dur-btn p-2 border border-gray-200 dark:border-gray-600 rounded-lg hover:border-indigo-500 hover:bg-indigo-50 dark:hover:bg-gray-700 text-sm font-medium text-gray-700 dark:text-gray-200 transition" data-val="60">60 Days</button>
                                <button onclick="challenges.selectDuration(90)" class="challenge-dur-btn p-2 border border-gray-200 dark:border-gray-600 rounded-lg hover:border-indigo-500 hover:bg-indigo-50 dark:hover:bg-gray-700 text-sm font-medium text-gray-700 dark:text-gray-200 transition" data-val="90">90 Days</button>
                            </div>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-700/30 p-4 rounded-lg border border-gray-100 dark:border-gray-700">
                            <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-2">Build Your Daily Routine</label>
                            <div class="flex gap-2 mb-3">
                                <input type="text" id="chal-new-task" placeholder="e.g. Reading" class="flex-1 bg-white dark:bg-gray-800 text-sm px-3 py-2 rounded border border-gray-200 dark:border-gray-600 focus:outline-none focus:border-indigo-500 dark:text-white">
                                <input type="number" id="chal-new-poms" value="1" min="1" class="w-14 bg-white dark:bg-gray-800 text-sm px-2 py-2 rounded border border-gray-200 dark:border-gray-600 text-center focus:outline-none focus:border-indigo-500 dark:text-white" title="Pomodoros">
                                <button onclick="challenges.addTempTask()" class="bg-indigo-600 text-white px-3 rounded hover:bg-indigo-700 transition font-bold"><i class="fa-solid fa-plus"></i></button>
                            </div>
                            <div id="chal-setup-list" class="space-y-2 max-h-40 overflow-y-auto mb-2"><p class="text-xs text-gray-400 italic text-center py-2">Add tasks to build your daily goal.</p></div>
                            <div class="flex justify-between items-center border-t border-gray-200 dark:border-gray-600 pt-3">
                                <span class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">Total Daily Target:</span>
                                <span class="text-lg font-bold text-indigo-600 dark:text-indigo-400"><span id="chal-total-calc">0</span> Poms</span>
                            </div>
                        </div>
                    </div>
                    <button onclick="challenges.start()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition shadow-lg transform active:scale-95">Start Challenge</button>
                </div>

                <div id="challenge-dashboard" class="hidden space-y-6">
                    <div class="bg-indigo-50 dark:bg-indigo-900/30 border border-indigo-100 dark:border-indigo-800 p-4 rounded-xl text-center">
                        <div class="text-xs uppercase tracking-widest text-indigo-400 mb-1">Current Mission</div>
                        <h3 class="text-xl font-bold text-indigo-700 dark:text-indigo-300"><span id="chal-name-display">Reading</span> for <span id="chal-target-display">4</span> Poms/Day</h3>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-1 bg-white dark:bg-gray-800 p-5 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col">
                            <h3 class="font-bold text-gray-800 dark:text-white mb-4 border-b border-gray-100 dark:border-gray-700 pb-2">Daily Routine</h3>
                            <div id="chal-dashboard-list" class="space-y-3 flex-1 overflow-y-auto max-h-60 mb-4"></div>
                            <button onclick="challenges.addToToday()" class="w-full bg-indigo-50 dark:bg-gray-700 text-indigo-600 dark:text-indigo-300 py-2 rounded-lg text-sm font-bold hover:bg-indigo-100 dark:hover:bg-gray-600 transition"><i class="fa-solid fa-plus mr-1"></i> Load to "Today"</button>
                        </div>
                        <div class="md:col-span-2 space-y-6">
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 text-center">
                                    <div class="text-xs text-gray-400 dark:text-gray-500 uppercase font-bold mb-1">Day</div>
                                    <div class="text-xl font-bold text-gray-700 dark:text-white"><span id="chal-current-day">1</span> / <span id="chal-total-days">30</span></div>
                                </div>
                                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 text-center">
                                    <div class="text-xs text-gray-400 dark:text-gray-500 uppercase font-bold mb-1">Streak</div>
                                    <div class="text-xl font-bold text-orange-500"><i class="fa-solid fa-fire mr-1"></i><span id="chal-streak">0</span></div>
                                </div>
                                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 text-center">
                                    <div class="text-xs text-gray-400 dark:text-gray-500 uppercase font-bold mb-1">Goal</div>
                                    <div class="text-xl font-bold text-indigo-600 dark:text-indigo-400"><span id="chal-today-done">0</span><span class="text-gray-400 text-lg mx-1">/</span><span id="chal-today-target">4</span></div>
                                </div>
                                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 text-center">
                                    <div class="text-xs text-gray-400 dark:text-gray-500 uppercase font-bold mb-1">Left</div>
                                    <div class="text-xl font-bold text-gray-700 dark:text-white" id="chal-days-left">30</div>
                                </div>
                            </div>
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="font-bold text-gray-700 dark:text-gray-200">Progress Map</h3>
                                    <button onclick="challenges.delete()" class="text-xs text-red-400 hover:text-red-600 font-medium">Give Up</button>
                                </div>
                                <div id="challenge-grid" class="grid grid-cols-7 sm:grid-cols-10 gap-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: REPORTS -->
            <div id="view-reports" class="hidden fade-in space-y-6">
                 <!-- Same Reports as before -->
                 <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Productivity Report</h2>
                    <select id="report-period" onchange="reports.render()" class="bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5">
                        <option value="today">Today</option>
                        <option value="week">Last 7 Days</option>
                        <option value="2weeks">Last 14 Days</option>
                        <option value="month">Last 30 Days</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
                        <div class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-1">Focus Time</div>
                        <div class="text-2xl font-bold text-indigo-600 dark:text-indigo-400"><span id="stat-hours">0</span><span class="text-sm text-gray-500 font-normal ml-1">hrs</span></div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
                        <div class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-1">Completed</div>
                        <div class="text-2xl font-bold text-emerald-600 dark:text-emerald-400"><span id="stat-poms">0</span><span class="text-sm text-gray-500 font-normal ml-1">poms</span></div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
                        <div class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-1">Tasks Done</div>
                        <div class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="stat-tasks">0</div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
                        <div class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-1">Reliability</div>
                        <div class="text-2xl font-bold text-purple-600 dark:text-purple-400"><span id="stat-reliability">0</span><span class="text-sm text-gray-500 font-normal ml-1">%</span></div>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
                    <h3 class="text-sm font-bold text-gray-700 dark:text-gray-300 mb-6">Activity Trend</h3>
                    <div id="chart-container" class="h-40 flex items-end justify-between gap-2"></div>
                </div>
            </div>

        </div>
    </main>

    <!-- Achievement Modal -->
    <div id="praise-overlay" class="fixed inset-0 pointer-events-none z-50 hidden flex items-center justify-center">
        <div class="bg-white dark:bg-gray-800 border-2 border-yellow-400 p-8 rounded-2xl shadow-2xl transform scale-100 pop-in text-center max-w-xs mx-4 relative">
            <div class="text-5xl mb-4">üèÜ</div>
            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">Daily Goal Met!</h3>
            <p class="text-gray-600 dark:text-gray-300">Streak increased! Keep it up.</p>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-md mx-4 overflow-hidden transform transition-all scale-100">
            <div class="bg-indigo-600 dark:bg-indigo-700 px-6 py-4 flex justify-between items-center">
                <h3 class="text-white font-bold text-lg">Settings</h3>
                <button onclick="app.toggleSettings()" class="text-indigo-200 hover:text-white transition"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-6 space-y-6 max-h-[80vh] overflow-y-auto">
                <!-- Daily Goal Settings (New) -->
                <div>
                    <h4 class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-3">Goals</h4>
                    <div>
                        <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Daily Pomodoro Goal</label>
                        <input type="number" id="setting-dailyGoal" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded p-2 text-center dark:text-white" min="1" max="50">
                        <p class="text-xs text-gray-400 mt-1">Set your default daily target.</p>
                    </div>
                </div>

                <!-- Timer Settings -->
                <div>
                    <h4 class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-3">Timer (Minutes)</h4>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Pomodoro</label>
                            <input type="number" id="setting-pomodoro" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded p-2 text-center dark:text-white" min="1" max="60">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Short Break</label>
                            <input type="number" id="setting-shortBreak" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded p-2 text-center dark:text-white" min="1" max="30">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Long Break</label>
                            <input type="number" id="setting-longBreak" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded p-2 text-center dark:text-white" min="1" max="60">
                        </div>
                    </div>
                </div>

                <!-- Toggles -->
                <div>
                    <h4 class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-3">Preferences</h4>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-700 dark:text-gray-300">Auto-start next timer</span>
                            <input type="checkbox" id="setting-autoStart" class="accent-indigo-600 w-4 h-4">
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-700 dark:text-gray-300">Browser Notifications</span>
                            <input type="checkbox" id="setting-notifications" class="accent-indigo-600 w-4 h-4" onchange="app.requestNotificationPermission(this)">
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-700 dark:text-gray-300">Sound Effects</span>
                            <input type="checkbox" id="setting-sound" class="accent-indigo-600 w-4 h-4">
                        </div>
                    </div>
                </div>

                <button onclick="app.saveSettings()" class="w-full bg-indigo-600 hover:bg-indigo-700 dark:bg-indigo-600 dark:hover:bg-indigo-500 text-white font-bold py-3 rounded-xl transition shadow-md">
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        const generateId = () => Math.random().toString(36).substr(2, 9);
        
        const Store = {
            getKey: (key) => {
                if (!app.state.user) return key; 
                return `${app.state.user}_${key}`;
            },
            get: (key, def) => {
                const stored = localStorage.getItem(Store.getKey(key));
                return stored ? JSON.parse(stored) : def;
            },
            set: (key, val) => localStorage.setItem(Store.getKey(key), JSON.stringify(val)),
        };

        const AudioSystem = {
            playBeep: () => {
                if (!app.state.settings.sound) return;
                try {
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.type = 'sine';
                    osc.frequency.value = 880; 
                    gain.gain.setValueAtTime(0.1, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.5);
                    osc.start();
                    osc.stop(ctx.currentTime + 0.5);
                } catch (e) { console.error("Audio error", e); }
            }
        };

        const QUOTES = [
            "Action is the foundational key to all success.",
            "Don't watch the clock; do what it does. Keep going.",
            "The secret of getting ahead is getting started.",
            "Focus on being productive instead of busy.",
            "It always seems impossible until it's done.",
            "Success is the sum of small efforts, repeated day in and day out.",
            "Lost time is never found again.",
            "Well done is better than well said."
        ];

        const DEFAULT_SETTINGS = {
            pomodoro: 25,
            shortBreak: 5,
            longBreak: 15,
            dailyGoal: 4,
            autoStart: false,
            notifications: false,
            sound: true,
            theme: 'light'
        };

        const app = {
            state: {
                user: null,
                tasks: [],
                completions: [], 
                settings: DEFAULT_SETTINGS,
                challenge: null,
                planner: { weekly: [], monthly: [] },
                activeTaskId: null,
                view: 'dashboard',
                globalStreak: 0
            },

            init: () => {
                const sessionUser = sessionStorage.getItem('focusflow_user');
                if (sessionUser) {
                    app.loadUser(sessionUser);
                } else {
                    document.getElementById('login-overlay').classList.remove('hidden');
                }
            },

            login: () => {
                const input = document.getElementById('login-username');
                const username = input.value.trim().toLowerCase().replace(/[^a-z0-9]/g, '');
                if (username.length < 3) {
                    alert("Please enter a username (at least 3 characters).");
                    return;
                }
                sessionStorage.setItem('focusflow_user', username);
                app.loadUser(username);
                document.getElementById('login-overlay').classList.add('hidden');
            },

            logout: () => {
                sessionStorage.removeItem('focusflow_user');
                window.location.reload(); 
            },

            loadUser: (username) => {
                app.state.user = username;
                document.getElementById('user-display-name').textContent = username;

                app.state.tasks = Store.get('focusflow_tasks', []);
                app.state.completions = Store.get('focusflow_completions', []);
                app.state.settings = Store.get('focusflow_settings', DEFAULT_SETTINGS);
                app.state.challenge = Store.get('focusflow_challenge', null);
                app.state.planner = {
                    weekly: Store.get('focusflow_planner_weekly', []),
                    monthly: Store.get('focusflow_planner_monthly', [])
                };
                
                app.applyTheme(app.state.settings.theme);
                timer.init();
                tasks.render();
                challenges.init();
                planner.render();
                app.loadQuote();
                app.setupIntervals();
                app.updateGlobalStreak();
                
                document.getElementById('setting-pomodoro').value = app.state.settings.pomodoro;
                document.getElementById('setting-shortBreak').value = app.state.settings.shortBreak;
                document.getElementById('setting-longBreak').value = app.state.settings.longBreak;
                document.getElementById('setting-dailyGoal').value = app.state.settings.dailyGoal || 4;
                document.getElementById('setting-autoStart').checked = app.state.settings.autoStart;
                document.getElementById('setting-notifications').checked = app.state.settings.notifications;
                document.getElementById('setting-sound').checked = app.state.settings.sound;

                if (app.state.tasks.length > 0 && !app.state.activeTaskId) {
                    const first = app.state.tasks.find(t => !t.completed);
                    if (first) app.setActiveTask(first.id);
                } else if (app.state.activeTaskId) {
                    app.updateActiveTaskDisplay();
                }
            },

            setupIntervals: () => {
                setInterval(app.loadQuote, 15 * 60 * 1000);
            },

            loadQuote: () => {
                const quote = QUOTES[Math.floor(Math.random() * QUOTES.length)];
                document.getElementById('quote-banner').textContent = `"${quote}"`;
            },

            toggleTheme: () => {
                const newTheme = app.state.settings.theme === 'dark' ? 'light' : 'dark';
                app.state.settings.theme = newTheme;
                app.applyTheme(newTheme);
                Store.set('focusflow_settings', app.state.settings);
            },

            applyTheme: (theme) => {
                const html = document.documentElement;
                const icon = document.getElementById('theme-icon');
                if (theme === 'dark') {
                    html.classList.add('dark');
                    icon.className = 'fa-solid fa-sun text-lg';
                } else {
                    html.classList.remove('dark');
                    icon.className = 'fa-solid fa-moon text-lg';
                }
            },

            toggleView: (viewName) => {
                app.state.view = viewName;
                document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
                document.getElementById(`view-${viewName}`).classList.remove('hidden');
                
                if (viewName === 'reports') reports.render();
                if (viewName === 'challenges') challenges.render();
                if (viewName === 'planner') planner.render();
            },

            toggleSettings: () => {
                const el = document.getElementById('settings-modal');
                el.classList.toggle('hidden');
            },

            saveSettings: () => {
                const newSettings = {
                    ...app.state.settings,
                    pomodoro: parseInt(document.getElementById('setting-pomodoro').value) || 25,
                    shortBreak: parseInt(document.getElementById('setting-shortBreak').value) || 5,
                    longBreak: parseInt(document.getElementById('setting-longBreak').value) || 15,
                    dailyGoal: parseInt(document.getElementById('setting-dailyGoal').value) || 4,
                    autoStart: document.getElementById('setting-autoStart').checked,
                    notifications: document.getElementById('setting-notifications').checked,
                    sound: document.getElementById('setting-sound').checked
                };

                app.state.settings = newSettings;
                Store.set('focusflow_settings', newSettings);
                timer.reset(); 
                app.toggleSettings();
                app.updateGlobalStreak(); // Refresh progress bar targets
            },

            requestNotificationPermission: (checkbox) => {
                if (checkbox.checked && "Notification" in window) {
                    Notification.requestPermission();
                }
            },

            sendNotification: (title, body) => {
                if (app.state.settings.notifications && Notification.permission === "granted") {
                    new Notification(title, { body, icon: 'https://cdn-icons-png.flaticon.com/512/2928/2928754.png' });
                }
            },

            setActiveTask: (id) => {
                app.state.activeTaskId = id;
                tasks.render();
                app.updateActiveTaskDisplay();
            },

            updateActiveTaskDisplay: () => {
                const display = document.getElementById('active-task-display');
                const titleEl = document.getElementById('active-task-title');
                
                const task = app.state.tasks.find(t => t.id === app.state.activeTaskId);
                if (task) {
                    display.classList.remove('hidden');
                    titleEl.textContent = task.title;
                } else {
                    display.classList.add('hidden');
                }
            },

            recordCompletion: () => {
                if (timer.mode !== 'pomodoro') return;

                const task = app.state.tasks.find(t => t.id === app.state.activeTaskId);
                
                app.state.completions.push({
                    id: generateId(),
                    taskId: task ? task.id : null,
                    type: 'pomodoro',
                    timestamp: Date.now()
                });
                Store.set('focusflow_completions', app.state.completions);

                if (task) {
                    task.completedPoms = (task.completedPoms || 0) + 1;
                    if (task.completedPoms >= task.targetPoms) {
                        task.completed = true;
                    }
                    Store.set('focusflow_tasks', app.state.tasks);
                    tasks.render();
                }

                app.updateGlobalStreak();
            },

            updateGlobalStreak: () => {
                // 1. Calculate Today's Progress
                const todayStart = new Date().setHours(0,0,0,0);
                const todayEnd = new Date().setHours(23,59,59,999);
                const todayPoms = app.state.completions.filter(c => c.timestamp >= todayStart && c.timestamp <= todayEnd).length;
                const target = app.state.settings.dailyGoal || 4;

                document.getElementById('goal-current').textContent = todayPoms;
                document.getElementById('goal-target').textContent = target;
                
                const pct = Math.min(100, (todayPoms / target) * 100);
                document.getElementById('goal-progress-bar').style.width = `${pct}%`;

                const statusText = document.getElementById('goal-status-text');
                if (pct >= 100) {
                    statusText.textContent = "Goal Met! üî•";
                    statusText.className = "text-xs font-bold text-orange-500";
                    document.getElementById('goal-progress-bar').classList.add('bg-orange-500');
                    document.getElementById('goal-progress-bar').classList.remove('bg-indigo-600');
                } else {
                    statusText.textContent = "Keep going!";
                    statusText.className = "text-xs font-medium text-indigo-500";
                    document.getElementById('goal-progress-bar').classList.add('bg-indigo-600');
                    document.getElementById('goal-progress-bar').classList.remove('bg-orange-500');
                }

                // 2. Calculate Historical Streak
                // Group history by day
                const historyByDay = {};
                app.state.completions.forEach(c => {
                    const dayKey = new Date(c.timestamp).toDateString();
                    historyByDay[dayKey] = (historyByDay[dayKey] || 0) + 1;
                });

                let streak = 0;
                // Check backward from today
                const ONE_DAY = 86400000;
                const now = new Date();
                
                // Check today first
                const todayKey = now.toDateString();
                if ((historyByDay[todayKey] || 0) >= target) {
                    streak++;
                }

                // Check past days
                for (let i = 1; i < 365; i++) {
                    const d = new Date(now.getTime() - (i * ONE_DAY));
                    const key = d.toDateString();
                    if ((historyByDay[key] || 0) >= target) {
                        streak++;
                    } else {
                        // Streak broken
                        break;
                    }
                }

                app.state.globalStreak = streak;
                document.getElementById('global-streak-count').textContent = streak;

                // Celebration Trigger (Exact hit)
                if (todayPoms === target) {
                    app.triggerConfetti();
                    const overlay = document.getElementById('praise-overlay');
                    overlay.querySelector('h3').textContent = "Daily Goal Met!";
                    overlay.querySelector('p').textContent = `You hit ${target} Pomodoros!`;
                    overlay.classList.remove('hidden');
                    setTimeout(() => overlay.classList.add('hidden'), 4000);
                }
            },

            triggerConfetti: () => {
                const colors = ['#f00', '#0f0', '#00f', '#ff0', '#0ff', '#f0f'];
                for (let i = 0; i < 50; i++) {
                    const conf = document.createElement('div');
                    conf.className = 'confetti';
                    conf.style.left = Math.random() * 100 + 'vw';
                    conf.style.top = -10 + 'px';
                    conf.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    conf.style.animationDuration = (Math.random() * 3 + 2) + 's';
                    document.body.appendChild(conf);
                    setTimeout(() => conf.remove(), 5000);
                }
            }
        };

        /**
         * PLANNER MODULE
         */
        const planner = {
            add: (type) => {
                const input = document.getElementById(`planner-${type}-input`);
                const text = input.value.trim();
                if(!text) return;

                app.state.planner[type].push({ id: generateId(), text });
                Store.set(`focusflow_planner_${type}`, app.state.planner[type]);
                input.value = '';
                planner.render();
            },

            delete: (type, id) => {
                app.state.planner[type] = app.state.planner[type].filter(item => item.id !== id);
                Store.set(`focusflow_planner_${type}`, app.state.planner[type]);
                planner.render();
            },

            moveToToday: (type, id) => {
                const item = app.state.planner[type].find(i => i.id === id);
                if(!item) return;

                const newTask = {
                    id: generateId(),
                    title: item.text,
                    targetPoms: 1,
                    completedPoms: 0,
                    completed: false,
                    createdAt: Date.now()
                };
                app.state.tasks.push(newTask);
                Store.set('focusflow_tasks', app.state.tasks);
                
                planner.delete(type, id);
                
                app.toggleView('dashboard');
                if(!app.state.activeTaskId) app.setActiveTask(newTask.id);
                tasks.render();
            },

            render: () => {
                ['weekly', 'monthly'].forEach(type => {
                    const list = document.getElementById(`planner-${type}-list`);
                    list.innerHTML = '';
                    
                    app.state.planner[type].forEach(item => {
                        const el = document.createElement('div');
                        el.className = "group flex items-center justify-between bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg border border-gray-100 dark:border-gray-600 hover:border-indigo-200 dark:hover:border-indigo-500 transition";
                        el.innerHTML = `
                            <span class="text-sm text-gray-700 dark:text-gray-200">${item.text}</span>
                            <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition">
                                <button onclick="planner.moveToToday('${type}', '${item.id}')" class="text-indigo-400 hover:text-indigo-600 dark:hover:text-indigo-300" title="Move to Today"><i class="fa-solid fa-arrow-right-to-bracket"></i></button>
                                <button onclick="planner.delete('${type}', '${item.id}')" class="text-gray-400 hover:text-red-500" title="Delete"><i class="fa-solid fa-xmark"></i></button>
                            </div>
                        `;
                        list.appendChild(el);
                    });
                });
            }
        };

        /**
         * CHALLENGES MODULE
         */
        const challenges = {
            tempDuration: 30,
            tempTasks: [],

            init: () => {
                // State loaded in app.init
            },

            selectDuration: (days) => {
                challenges.tempDuration = days;
                document.querySelectorAll('.challenge-dur-btn').forEach(btn => {
                    if(parseInt(btn.dataset.val) === days) {
                        btn.classList.add('border-indigo-500', 'bg-indigo-50', 'dark:bg-gray-700', 'text-indigo-600', 'dark:text-white');
                        btn.classList.remove('text-gray-700');
                    } else {
                        btn.classList.remove('border-indigo-500', 'bg-indigo-50', 'dark:bg-gray-700', 'text-indigo-600', 'dark:text-white');
                        btn.classList.add('text-gray-700');
                    }
                });
            },

            addTempTask: () => {
                const nameIn = document.getElementById('chal-new-task');
                const pomIn = document.getElementById('chal-new-poms');
                const name = nameIn.value.trim();
                const poms = parseInt(pomIn.value) || 1;

                if (!name) return;

                challenges.tempTasks.push({ name, poms });
                nameIn.value = '';
                pomIn.value = 1;
                challenges.updateSetupUI();
            },

            removeTempTask: (idx) => {
                challenges.tempTasks.splice(idx, 1);
                challenges.updateSetupUI();
            },

            updateSetupUI: () => {
                const list = document.getElementById('chal-setup-list');
                const totalEl = document.getElementById('chal-total-calc');
                list.innerHTML = '';
                
                let total = 0;
                if (challenges.tempTasks.length === 0) {
                     list.innerHTML = '<p class="text-xs text-gray-400 italic text-center py-2">Add tasks to build your daily goal.</p>';
                } else {
                    challenges.tempTasks.forEach((t, i) => {
                        total += t.poms;
                        const el = document.createElement('div');
                        el.className = "flex justify-between items-center text-sm bg-white dark:bg-gray-800 p-2 rounded border border-gray-100 dark:border-gray-600";
                        el.innerHTML = `
                            <span class="text-gray-700 dark:text-gray-200">${t.name} <span class="text-indigo-500 text-xs font-bold ml-1">(${t.poms} Poms)</span></span>
                            <button onclick="challenges.removeTempTask(${i})" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
                        `;
                        list.appendChild(el);
                    });
                }
                totalEl.textContent = total;
            },

            start: () => {
                if (challenges.tempTasks.length === 0) {
                    alert("Please add at least one task to your routine.");
                    return;
                }

                const now = new Date();
                const startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
                const totalTarget = challenges.tempTasks.reduce((acc, t) => acc + t.poms, 0);

                app.state.challenge = {
                    startDate: startDate,
                    duration: challenges.tempDuration,
                    target: totalTarget,
                    tasks: challenges.tempTasks 
                };
                Store.set('focusflow_challenge', app.state.challenge);
                challenges.render();
            },

            delete: () => {
                if(confirm("Are you sure you want to give up this challenge?")) {
                    app.state.challenge = null;
                    Store.set('focusflow_challenge', null);
                    challenges.render();
                }
            },

            addToToday: () => {
                if (!app.state.challenge || !app.state.challenge.tasks) return;
                
                let addedCount = 0;
                app.state.challenge.tasks.forEach(chalTask => {
                     const newTask = {
                        id: generateId(),
                        title: chalTask.name,
                        targetPoms: chalTask.poms,
                        completedPoms: 0,
                        completed: false,
                        createdAt: Date.now()
                    };
                    app.state.tasks.push(newTask);
                    addedCount++;
                });

                Store.set('focusflow_tasks', app.state.tasks);
                
                app.toggleView('dashboard');
                tasks.render();
                if (addedCount > 0 && !app.state.activeTaskId) {
                    app.setActiveTask(app.state.tasks[app.state.tasks.length - addedCount].id);
                }
            },

            checkDailyGoal: () => {
                if (!app.state.challenge) return;
                
                const todayStart = new Date().setHours(0,0,0,0);
                const todayEnd = new Date().setHours(23,59,59,999);
                
                const todayPoms = app.state.completions.filter(c => 
                    c.timestamp >= todayStart && c.timestamp <= todayEnd
                ).length;

                if (todayPoms === app.state.challenge.target) {
                    challenges.showPraise();
                }
            },

            showPraise: () => {
                const overlay = document.getElementById('praise-overlay');
                overlay.classList.remove('hidden');
                setTimeout(() => {
                    overlay.classList.add('hidden');
                }, 4000);
            },

            render: () => {
                const setupView = document.getElementById('challenge-setup');
                const dashView = document.getElementById('challenge-dashboard');
                
                if (!app.state.challenge) {
                    setupView.classList.remove('hidden');
                    dashView.classList.add('hidden');
                    challenges.selectDuration(30); 
                    challenges.tempTasks = [];
                    challenges.updateSetupUI();
                    return;
                }

                setupView.classList.add('hidden');
                dashView.classList.remove('hidden');

                const { startDate, duration, target, tasks, taskName } = app.state.challenge;
                
                const displayName = (tasks && tasks.length > 0) ? `${tasks.length} Task Routine` : (taskName || "Daily Focus");
                document.getElementById('chal-name-display').textContent = displayName;
                document.getElementById('chal-target-display').textContent = target;

                const dashList = document.getElementById('chal-dashboard-list');
                dashList.innerHTML = '';
                if (tasks && tasks.length > 0) {
                    tasks.forEach(t => {
                        const el = document.createElement('div');
                        el.className = "flex items-center justify-between text-sm text-gray-700 dark:text-gray-200 p-2 bg-gray-50 dark:bg-gray-700/50 rounded";
                        el.innerHTML = `<span>${t.name}</span> <span class="font-bold text-indigo-500">${t.poms} <i class="fa-solid fa-clock text-[10px]"></i></span>`;
                        dashList.appendChild(el);
                    });
                } else {
                    dashList.innerHTML = `<div class="text-gray-500 text-sm">Daily Goal: ${target} Poms</div>`;
                }

                const grid = document.getElementById('challenge-grid');
                grid.innerHTML = '';
                
                const ONE_DAY = 86400000;
                const now = new Date().getTime();
                const todayStart = new Date().setHours(0,0,0,0);

                let streak = 0;
                let todayDone = 0;
                
                for (let i = 0; i < duration; i++) {
                    const dayTs = startDate + (i * ONE_DAY);
                    const dayEndTs = dayTs + ONE_DAY - 1;
                    const isToday = dayTs === todayStart;
                    const isFuture = dayTs > now;
                    const poms = app.state.completions.filter(c => c.timestamp >= dayTs && c.timestamp <= dayEndTs).length;
                    const metGoal = poms >= target;
                    if (isToday) todayDone = poms;

                    const box = document.createElement('div');
                    box.className = "aspect-square rounded-md flex items-center justify-center text-[10px] font-bold transition relative group cursor-default";
                    
                    if (isFuture) {
                        box.classList.add('bg-gray-100', 'dark:bg-gray-700', 'text-gray-300', 'dark:text-gray-600', 'border', 'border-gray-200', 'dark:border-gray-600');
                    } else if (isToday) {
                        box.classList.add(metGoal ? 'bg-emerald-500' : 'bg-indigo-500', 'text-white', 'ring-2', 'ring-offset-2', 'ring-indigo-200', 'dark:ring-offset-gray-800', 'dark:ring-indigo-900');
                    } else if (metGoal) {
                        box.classList.add('bg-emerald-500', 'text-white');
                    } else {
                        box.classList.add('bg-red-400', 'text-white');
                    }

                    box.textContent = i + 1;
                    box.title = `Day ${i+1}: ${poms}/${target} Poms`;
                    grid.appendChild(box);
                }

                let currentStreak = 0;
                for(let i = 0; i < duration; i++) {
                     const dayTs = todayStart - (i * ONE_DAY);
                     if (dayTs < startDate) break; 
                     const dayEndTs = dayTs + ONE_DAY - 1;
                     const poms = app.state.completions.filter(c => c.timestamp >= dayTs && c.timestamp <= dayEndTs).length;
                     if (poms >= target) currentStreak++;
                     else if (dayTs !== todayStart) break;
                }
                
                const currentDayIndex = Math.floor((now - startDate) / ONE_DAY) + 1;
                document.getElementById('chal-current-day').textContent = Math.max(1, Math.min(currentDayIndex, duration));
                document.getElementById('chal-total-days').textContent = duration;
                document.getElementById('chal-streak').textContent = currentStreak;
                document.getElementById('chal-today-done').textContent = todayDone;
                document.getElementById('chal-today-target').textContent = target;
                const lastDay = startDate + (duration * ONE_DAY);
                const daysLeft = Math.ceil((lastDay - now) / ONE_DAY);
                document.getElementById('chal-days-left').textContent = Math.max(0, daysLeft);
            }
        };

        const timer = {
            mode: 'pomodoro', 
            remaining: 25 * 60,
            isRunning: false,
            interval: null,
            endTime: null,
            totalTime: 25 * 60,

            init: () => {
                const saved = Store.get('focusflow_timer', null);
                if (saved) {
                    timer.mode = saved.mode;
                    timer.totalTime = app.state.settings[saved.mode] * 60;
                    if (saved.isRunning) {
                        const now = Date.now();
                        const left = Math.ceil((saved.endTime - now) / 1000);
                        if (left > 0) {
                            timer.remaining = left;
                            timer.start(true); 
                        } else {
                            timer.remaining = 0;
                            timer.setMode(saved.mode); 
                        }
                    } else {
                        timer.remaining = saved.remaining;
                    }
                } else {
                    timer.reset();
                }
                timer.setModeUI(timer.mode);
                timer.updateDisplay();
            },

            saveState: () => {
                Store.set('focusflow_timer', {
                    mode: timer.mode,
                    remaining: timer.remaining,
                    isRunning: timer.isRunning,
                    endTime: timer.endTime
                });
            },

            setMode: (mode) => {
                timer.pause();
                timer.mode = mode;
                const minutes = app.state.settings[mode];
                timer.remaining = minutes * 60;
                timer.totalTime = timer.remaining;
                timer.setModeUI(mode);
                timer.updateDisplay();
                timer.saveState();
            },

            setModeUI: (mode) => {
                document.querySelectorAll('[id^="tab-"]').forEach(el => {
                    el.className = "flex-1 py-1 text-sm font-medium rounded-md text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition-all";
                });
                const activeTab = document.getElementById(`tab-${mode}`);
                if(activeTab) {
                    activeTab.className = "flex-1 py-1 text-sm font-medium rounded-md shadow-sm bg-white dark:bg-gray-600 text-indigo-600 dark:text-indigo-300 transition-all";
                }
                const ring = document.getElementById('timer-ring');
                ring.classList.remove('text-indigo-600', 'dark:text-indigo-500', 'text-emerald-500', 'dark:text-emerald-400');
                if (mode === 'pomodoro') {
                     ring.classList.add('text-indigo-600', 'dark:text-indigo-500');
                } else {
                     ring.classList.add('text-emerald-500', 'dark:text-emerald-400');
                }
            },

            toggle: () => {
                if (timer.isRunning) timer.pause();
                else timer.start();
            },

            start: (resume = false) => {
                if (timer.isRunning && !resume) return;
                timer.isRunning = true;
                if (!resume) {
                    timer.endTime = Date.now() + (timer.remaining * 1000);
                } else {
                     if(!timer.endTime) timer.endTime = Date.now() + (timer.remaining * 1000);
                }
                timer.saveState();
                document.getElementById('btn-toggle').innerHTML = '<i class="fa-solid fa-pause text-xl"></i>';
                document.getElementById('timer-status').textContent = timer.mode === 'pomodoro' ? 'Focusing...' : 'Recharging...';
                if (timer.interval) clearInterval(timer.interval);
                timer.interval = setInterval(() => {
                    const now = Date.now();
                    const left = Math.ceil((timer.endTime - now) / 1000);
                    if (left <= 0) {
                        timer.finish();
                    } else {
                        timer.remaining = left;
                        timer.updateDisplay();
                        if (left % 5 === 0) timer.saveState(); 
                    }
                }, 100);
            },

            pause: () => {
                if (!timer.isRunning) return;
                timer.isRunning = false;
                clearInterval(timer.interval);
                timer.saveState();
                document.getElementById('btn-toggle').innerHTML = '<i class="fa-solid fa-play text-xl pl-1"></i>';
                document.getElementById('timer-status').textContent = 'Paused';
            },

            stop: () => {
                timer.pause();
                timer.setMode(timer.mode); 
                document.getElementById('timer-status').textContent = 'Stopped';
            },

            finish: () => {
                timer.pause();
                timer.remaining = 0;
                timer.updateDisplay();
                AudioSystem.playBeep();
                if (timer.mode === 'pomodoro') {
                    app.recordCompletion();
                    challenges.checkDailyGoal(); 
                    app.sendNotification("Focus Complete!", "Take a break, you earned it.");
                    const currentTask = app.state.tasks.find(t => t.id === app.state.activeTaskId);
                    if (currentTask && (currentTask.completed || currentTask.completedPoms >= currentTask.targetPoms)) {
                        const remainingTasks = app.state.tasks.filter(t => !t.completed && t.id !== currentTask.id);
                        if (remainingTasks.length > 0) {
                            app.setActiveTask(remainingTasks[0].id);
                        }
                    }
                    timer.setMode('shortBreak');
                } else {
                    app.sendNotification("Break Over!", "Time to get back to focus.");
                    timer.setMode('pomodoro');
                }
                if (app.state.settings.autoStart) {
                    setTimeout(() => timer.start(), 1500);
                }
            },

            reset: () => {
                timer.pause();
                timer.setMode(timer.mode);
            },

            updateDisplay: () => {
                const mins = Math.floor(timer.remaining / 60).toString().padStart(2, '0');
                const secs = (timer.remaining % 60).toString().padStart(2, '0');
                document.getElementById('timer-display').textContent = `${mins}:${secs}`;
                document.title = `${mins}:${secs} - FocusFlow`; 
                const circle = document.getElementById('timer-ring');
                const radius = circle.r.baseVal.value;
                const circumference = radius * 2 * Math.PI;
                const offset = circumference - (timer.remaining / timer.totalTime) * circumference;
                circle.style.strokeDashoffset = offset;
            }
        };

        const tasks = {
            add: () => {
                const titleInput = document.getElementById('new-task-title');
                const estInput = document.getElementById('new-task-est');
                const title = titleInput.value.trim();
                if (!title) return;
                const newTask = {
                    id: generateId(),
                    title: title,
                    targetPoms: parseInt(estInput.value) || 1,
                    completedPoms: 0,
                    completed: false,
                    createdAt: Date.now()
                };
                app.state.tasks.push(newTask);
                Store.set('focusflow_tasks', app.state.tasks);
                if (!app.state.activeTaskId) app.setActiveTask(newTask.id);
                titleInput.value = '';
                estInput.value = '1';
                tasks.render();
            },

            delete: (id, e) => {
                e.stopPropagation();
                app.state.tasks = app.state.tasks.filter(t => t.id !== id);
                if (app.state.activeTaskId === id) {
                    app.state.activeTaskId = null;
                    app.updateActiveTaskDisplay();
                }
                Store.set('focusflow_tasks', app.state.tasks);
                tasks.render();
            },

            toggleComplete: (id, e) => {
                e.stopPropagation();
                const task = app.state.tasks.find(t => t.id === id);
                if (task) {
                    task.completed = !task.completed;
                    Store.set('focusflow_tasks', app.state.tasks);
                    tasks.render();
                }
            },

            clearCompleted: () => {
                app.state.tasks = app.state.tasks.filter(t => !t.completed);
                Store.set('focusflow_tasks', app.state.tasks);
                tasks.render();
            },

            render: () => {
                const list = document.getElementById('task-list');
                const empty = document.getElementById('empty-state');
                list.innerHTML = '';
                if (app.state.tasks.length === 0) {
                    list.classList.add('hidden');
                    empty.classList.remove('hidden');
                    empty.classList.add('flex');
                    return;
                }
                list.classList.remove('hidden');
                empty.classList.add('hidden');
                empty.classList.remove('flex');
                const sortedTasks = [...app.state.tasks].sort((a, b) => {
                    if (a.completed === b.completed) return b.createdAt - a.createdAt;
                    return a.completed ? 1 : -1;
                });
                sortedTasks.forEach(task => {
                    const isActive = task.id === app.state.activeTaskId;
                    const el = document.createElement('div');
                    el.className = `group flex items-center justify-between p-3 rounded-xl border transition cursor-pointer hover:shadow-sm ${isActive ? 'bg-indigo-50 border-indigo-200 dark:bg-gray-800 dark:border-indigo-500 ring-1 ring-indigo-200 dark:ring-indigo-500' : 'bg-white dark:bg-gray-800 border-gray-100 dark:border-gray-700 hover:border-indigo-100 dark:hover:border-indigo-500'}`;
                    el.onclick = () => app.setActiveTask(task.id);
                    let pomHtml = '';
                    for(let i=0; i<task.targetPoms; i++) {
                        if (i < task.completedPoms) {
                            pomHtml += `<i class="fa-solid fa-circle text-[10px] text-indigo-500 dark:text-indigo-400"></i>`;
                        } else {
                            pomHtml += `<i class="fa-regular fa-circle text-[10px] text-gray-300 dark:text-gray-600"></i>`;
                        }
                    }
                    el.innerHTML = `
                        <div class="flex items-center gap-3 overflow-hidden">
                            <button onclick="tasks.toggleComplete('${task.id}', event)" class="text-xl ${task.completed ? 'text-emerald-500 dark:text-emerald-400' : 'text-gray-300 dark:text-gray-600 hover:text-indigo-500 dark:hover:text-indigo-400'} transition">
                                <i class="fa-regular ${task.completed ? 'fa-circle-check' : 'fa-circle'}"></i>
                            </button>
                            <div class="flex flex-col overflow-hidden">
                                <span class="${task.completed ? 'line-through text-gray-400 dark:text-gray-500' : 'text-gray-800 dark:text-gray-200 font-medium'} truncate transition">${task.title}</span>
                                <div class="flex gap-1 mt-1">
                                    ${pomHtml}
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center opacity-0 group-hover:opacity-100 transition">
                            <button onclick="tasks.delete('${task.id}', event)" class="text-gray-300 dark:text-gray-500 hover:text-red-500 dark:hover:text-red-400 p-2">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    `;
                    list.appendChild(el);
                });
            }
        };

        const reports = {
            render: () => {
                const period = document.getElementById('report-period').value;
                const now = new Date();
                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
                let startTime = todayStart;
                let days = 1;
                if (period === 'week') {
                    startTime = todayStart - (6 * 24 * 60 * 60 * 1000);
                    days = 7;
                } else if (period === '2weeks') {
                    startTime = todayStart - (13 * 24 * 60 * 60 * 1000);
                    days = 14;
                } else if (period === 'month') {
                    startTime = todayStart - (29 * 24 * 60 * 60 * 1000);
                    days = 30;
                }
                const relevantCompletions = app.state.completions.filter(c => c.timestamp >= startTime);
                const totalPoms = relevantCompletions.length;
                const totalMinutes = totalPoms * app.state.settings.pomodoro;
                const totalHours = (totalMinutes / 60).toFixed(1);
                const uniqueTasks = new Set(relevantCompletions.map(c => c.taskId).filter(id => id));
                const tasksInPeriod = app.state.tasks.filter(t => t.createdAt >= startTime || t.completed);
                const completedTasksCount = tasksInPeriod.filter(t => t.completed).length;
                const reliability = tasksInPeriod.length > 0 ? Math.round((completedTasksCount / tasksInPeriod.length) * 100) : 0;
                document.getElementById('stat-poms').textContent = totalPoms;
                document.getElementById('stat-hours').textContent = totalHours;
                document.getElementById('stat-tasks').textContent = uniqueTasks.size; 
                document.getElementById('stat-reliability').textContent = reliability;
                reports.drawChart(relevantCompletions, startTime, days);
            },
            drawChart: (completions, startTime, days) => {
                const container = document.getElementById('chart-container');
                container.innerHTML = '';
                const data = new Array(days).fill(0);
                completions.forEach(c => {
                    const dayIndex = Math.floor((c.timestamp - startTime) / (24 * 60 * 60 * 1000));
                    if (dayIndex >= 0 && dayIndex < days) {
                        data[dayIndex]++;
                    }
                });
                const max = Math.max(...data, 1); 
                data.forEach((count, i) => {
                    const bar = document.createElement('div');
                    const height = (count / max) * 100;
                    bar.className = "flex-1 bg-indigo-100 dark:bg-gray-700 rounded-t hover:bg-indigo-200 dark:hover:bg-gray-600 transition relative group";
                    bar.style.height = `${Math.max(height, 5)}%`; 
                    bar.innerHTML = `
                        <div class="opacity-0 group-hover:opacity-100 absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gray-800 dark:bg-gray-900 text-white text-xs rounded py-1 px-2 pointer-events-none transition whitespace-nowrap z-20">
                            ${count} Poms
                        </div>
                    `;
                    container.appendChild(bar);
                });
            }
        };

        window.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>
</html>